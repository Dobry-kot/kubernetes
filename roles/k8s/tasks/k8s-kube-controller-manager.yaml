---
- name: SETUP KUBE-CONTROLLER-MANGER.
  vars:
    k8s_component: kube-controller-manager
  block:
    - name: DOWNLOAD BASIC BINARY K8S-COMPONENTS.
      get_url:
        url: "{{ k8s_component_bin.url }}"
        dest: "{{ k8s_component_bin.path }}"
        mode: 0775
      loop:
        - url: "{{ kube_controller_manager_build.bin.path }}/v{{ kube_controller_manager_build.bin.version }}/bin/linux/{{ arch }}/{{ k8s_component }}"
          path: /usr/bin/
      loop_control:
          loop_var: k8s_component_bin

    - name: Create a directory if it does not exist
      ansible.builtin.file:
        path: "{{ k8s_component_path }}"
        state: directory
        mode: '0775'
      loop:
        - "{{ default_path }}/{{ k8s_component }}"
        - "{{ pki_path_certs }}/{{ k8s_component }}"
      loop_control:
          loop_var: k8s_component_path

    - name: SSL BLOCK.
      block:
        - name: CREATE CERT <{{ k8s_component }}> SERVER.
          vars:
            hosts_list: 
              - "127.0.0.1"
              - "127.0.1.1"
              - "127.0.1.6"
              - "localhost"
              - "{{ k8s_component }}.svc"
              - "{{ ansible_default_ipv4.address }}"
              - "{{ inventory_hostname }}"
            csr:
              CN: "system:{{ k8s_component }}-server"
              names:
                - O: "system:{{ k8s_component }}"
              hosts: "{{ hosts_list + groups.masters }}"
            profile: server
            ca: root
          include_role:
            name: k8s
            tasks_from: k8s-certificate-template.yaml
            apply:
              tags:
                - kube_controller_manager_ssl

        - name: CREATE CERT <{{ k8s_component }}> CLIENT.
          vars:
            csr:
              CN: "system:{{ k8s_component }}"
              names:
                - O: "system:{{ k8s_component }}"
            profile: client
            ca: root
          include_role:
            name: k8s
            tasks_from: k8s-certificate-template.yaml
            apply:
              tags:
                - kube_controller_manager_ssl
      tags:
        - kube_controller_manager_ssl

    - name: LIST BASIC CONFIGS
      vars:
        basic_configs:
          - name: kubeconfig.j2
        service_configs:
          - name: service-args.j2
            folder: "{{ k8s_component }}"
          - name: config.j2
      set_fact:
        configs_in_copy: |
          {% if setup_cluster_type == 'service' %}
          {{ basic_configs + service_configs }}
          {% elif setup_cluster_type == 'static-pod' %}
          {{ basic_configs }}
          {% endif %}

    - name: COPY CONFIGS.
      vars:
        kubeconfig_cert: system:{{ k8s_component }}
      include_role:
        name: k8s
        tasks_from: k8s-copy-configs.yaml
        apply:
          tags:
            - kube_controller_manager_configs_update
      tags:
        - kube_controller_manager_configs_update

    - name: ADD NEW SERVICES.
      vars:
        services_list:
          - "{{ k8s_component }}.service"
      import_role:
        name: k8s
        tasks_from: k8s-service-create.yaml
      tags:
        - kube_controller_manager_service_update
      when: setup_cluster_type == 'service'

    - name: COPY MANIFESTS.
      vars:
        default_path: /etc/kubernetes
      ansible.builtin.template:
        src: "configs/{{ config.folder | default('') }}/{{ config.name }}"
        dest: "{{ config.path | default(default_path) }}/manifests/{{ config.name.split('.j2')[0] }}"
        owner: root
        group: root
        mode: '0775'
      loop:
        - name: kube-controller-manager.yaml.j2
          folder: "{{ k8s_component }}"
      loop_control:
          loop_var: config
      tags:
        - kube_controller_manager_manifest_update
      when: setup_cluster_type == 'static-pod'